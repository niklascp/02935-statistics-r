\NeedsTeXFormat{LaTeX2e}
\documentclass[a4paper,11pt]{article}
\usepackage[utf8]{inputenc}

\usepackage[affil-it]{authblk}
\usepackage{natbib}

\usepackage{setspace}

\usepackage{booktabs}
\usepackage{amsmath}
\usepackage{amssymb}
\usepackage{epsfig}

\usepackage{marvosym}

\usepackage{graphicx}
\usepackage{caption}
\usepackage{subcaption}
\usepackage{multicol}
\usepackage{etoolbox}

\usepackage{todonotes}

\usepackage{tikz}

%\usepackage{hyperref}
\usepackage[nameinlink]{cleveref}

\setlength{\textheight}{9in}
\setlength{\textwidth}{6in}
\setlength{\oddsidemargin}{.25in}
\setlength{\topmargin}{-.5in} 

\setcitestyle{authoryear, open={(},close={)}}
%\patchcmd{\thebibliography}{\section*{\refname}}
%    {\begin{multicols}{2}[\section*{\refname}\singlespace\footnotesize]}{}{}
%\patchcmd{\endthebibliography}{\endlist}{\endlist\end{multicols}}{}{}

\hyphenation{itself}

\title{{\small 02935 Introduction to applied statistics and R for PhD students: }\\[1em]Statistical report: Weather and travel demand}

\author{Niklas Christoffer Petersen}
\affil{Transport Modelling, Department of Management Engineering \\ Technical University of Denmark, 2800 Kongens Lyngby, Denmark}

%\affil{Trafikselskabet Movia \\ Technical University of Denmark, 2800 Kongens Lyngby, Denmark}

\begin{document}
\singlespace
\maketitle
\thispagestyle{empty}
\clearpage

\onehalfspacing
\pagenumbering{arabic}
\tableofcontents
\clearpage

\section{Background}\label{ch:background}

Observing and predicting the demand for bus travel is of major impact for designing and operating an efficient public transport system in any urban area. It is a common understanding, that there are several external factors that impact the travel demand. Examples include weather, events, etc. It is however uncertain how much each factor really contributes to fluctuation in travel demand. 

\subsection{Related work}\label{ch:relatedWork}
The impact of weather conditions on transport is a well-studied area within the scientific field of transport modeling.
TODO

For weather conditions, only sunny days and rainy days are considered: \citet{Yo2010}

\clearpage

\section{Data description}\label{ch:desc}
As established earlier, the goal of this project is to shed light upon the impact of specifically weather as an external factor for bus travel demand. For this, both historical weather data, and measures of historical travel demand should be analyzed.

\subsection{Travel demand data}\label{ch:desc_traveldemand}

Travel demand data was obtained and prepared as described in \Cref{appx:travel_demand_data_prep}. The preprocessed travel demand data is a quite simple time series containing number of passenger boardings for each date, time in terms of the hour of the day, and date of week. \Cref{tab:travel_demand_data_attr} shows the attributes in the travel demand date set, and \Cref{tab:travel_demand_data_example} shows an example of the data set.

\begin{table}[!ht]
    \center
    \begin{tabular}{p{1in}p{4in}}        
        Attribute & Description \\
        \hline 
        \hline         
        Date & The date of the observation (2016-10-01 - 2017-03-31). \\
        \hline 
        Hour & The hour of the observation (0--23, e.g.\ hour = 0 means between 00:00 and 01:00). \\
        \hline 
        Date of week & The day of the week of the observation (Mon - Sat), with statutory holidays encoded as Saturdays. \\
        \hline 
        Check in count & Number of passenger boardings using the smart-card ticketing system. \\
    \end{tabular}
    \caption{Attributes in the travel demand data set.}
    \label{tab:travel_demand_data_attr}
\end{table}

\begin{table}[!ht]
    \center
    %\includegraphics{../plots/travelcard_hist.pdf}
    \input{../tables/travel_demand_data_example.tex}
    \caption{Example of the travel demand data set.}
    \label{tab:travel_demand_data_example}
\end{table}


\Cref{fig:travelcard_boxplot} shows the boxplot of passenger boardings over the different days of week, where the notches gives a roughly 95\% confidence interval for comparing medians cf.~\citet{Boxplots}. The plot suggests that travel demand of Monday--Thursday could follow quite similar distributions, while Friday, Saturday and Sunday seems to each have a distinct travel demand distribution from the rest of the week.

\clearpage
\begin{figure}[!ht]
    \center
    %\includegraphics{../plots/travelcard_hist.pdf}
    \input{../plots/travelcard_boxplot.tex}
    \caption{Passenger boardings by day of week.}
    \label{fig:travelcard_boxplot}
\end{figure}

Intuitively travel demand also varies throughout the day as shown in~\Cref{fig:travelcard_hist}: On an average weekday, most passengers boardings for each hour are in the morning peek hours (7--9), and afternoon peek hours (15--18). It suggest that the weekdays seem to behave vary similar between early morning and work hours (e.g.\ 2--16), except Friday, which looks to have more demand in general. After 16 the weekdays seem to deviate from each a bit more. It also suggest that weekends has a clearly different demand pattern, with much more demand in the night hours.

\begin{figure}[!ht]
    \center
    %\includegraphics{../plots/travelcard_hist.pdf}
    \input{../plots/travelcard_hist.tex}
    \caption{Mean passenger boardings by hour of day and day of week.}
    \label{fig:travelcard_hist}
\end{figure}
\clearpage

\subsection{Weather data}\label{ch:desc_weather}
Historical weather data was obtained and prepared as described in \Cref{appx:weather_data_prep}. The preprocessed weather data is a more advanced time series containing several measurements for each time step. \Cref{tab:weather_data_attr} shows the attributes in the weather date set, and \Cref{tab:weather_data_example} shows an example of the data set.

\begin{table}[!ht]
    \center
    \begin{tabular}{p{1in}p{4in}}        
        Attribute & Description \\
        \hline 
        \hline 
        Date/time & The date and time of the observation (2016-10-01 00:00 - 2017-03-31 23:50). \\
        \hline         
        Temperature & The measured temperature in degree Celsius. \\
        \hline         
        Dew point & The measured dew point in degree Celsius. Temperature below which water will begin to condense. \\
        \hline         
        Wind speed & The measured wind speed in kilometers per hour. \\
        \hline         
        Gust speed & The measured gust speed in kilometers per hour. \\
        \hline         
        Humidity & The measured humidity in percentage. \\
        \hline         
        Precipitation & The precipitation for the entire day in mm. \\
        \hline         
        Rain & The rain condition level at the measurement from 1 to 7: 'Light Rain Showers', 'Light Rain',
  'Rain Showers', 'Rain',
  'Heavy Rain Showers', 'Heavy Rain',
  'Freezing Rain' (0 = no rain). \\
    \end{tabular}
    \caption{Attributes in the travel demand data set.}
    \label{tab:weather_data_attr}
\end{table}

\todo{Remove Gust?}Notice that gust speed is only available if any sudden, brief increase in the speed of the wind followed by a lull is recorded shortly up to the measurement.
 
\begin{table}[!ht]
    \center
    \resizebox{\linewidth}{!}{
    \input{../tables/weather_data_example.tex}
    }
    \caption{Example of the weather data set.}
    \label{tab:weather_data_example}
\end{table}

Weather conditions seems quite sparse, e.g.\ as shown in \Cref{fig:weather_hist} rain conditions are only observed $\approx10 \%$ of the time. And two thirds of the time the rain precipitation is considered \emph{light}.

\begin{figure}[!ht]
    \center
    \input{../plots/weather_hist.tex}
    \caption{Frequency of different levels of rain.}
    \label{fig:weather_hist}
\end{figure}

\clearpage

\section{Statistical analysis}
With a good understanding of the two data sets, we move on to the statistical analysis of the impact of weather on travel demand.

\subsection{Normilization of travel demand}
As etablished by the descriptive analysis of travel demand data in \Cref{ch:desc_traveldemand}, the expected demand varies throughout the time of the day, and the day of the week. In order to find any impacts of weather we must focus on diviations from the normal and expected fluctuations.

The approach for this is to fit a linear regression model on the travel demand data, using time of the day and day of the week (and their interaction), along with an overall day measure as shown in~(\ref{eq:fit}). The last term is simply number of days from first date in the data set, and allows for an overall increase/decline of travel demand. 
\begin{equation}
    \sqrt[\leftroot{0}\uproot{2}4]{\textit{CheckInCount}} \sim \textit{DayOfWeek} + \textit{Hour} + \textit{DayOfWeek}:\textit{Hour} + \textit{Day}    
    \label{eq:fit}
\end{equation}

Notice that we transform the response to the fourth root of the travel demand. This is to ensure homoscedasticity of error. We verify that model assumptions hold using \Cref{fit-assumptions}. From the \emph{Residuals vs Fitted}-plot we see linear behavior, and normal error is also acceptable cf. \emph{Normal Q-Q}-plot. Constant variance of error is also confirmed by the uniform spread in the \emph{Scale-Location}-plot. Finally we might identify some outliers in the \emph{Residuals vs Fitted}-plot, but as outliers is part of what we are trying to identify (e.g. any non-normal travel demand), we will not remove any of them.

The model is then applied to the data, as illustrated in the example in \Cref{fig:travelcard_pred}, which simply shows the first whole week in the data set.
\begin{figure}[!ht]
    \center
    \input{../plots/travelcard_pred.tex}
    \vspace{-1em}
    \caption{Predicted passenger boardings of a single week.}
    \label{fig:travelcard_pred}
\end{figure}

\clearpage
\begin{figure}[!p]
    \center
    \includegraphics[width=\textwidth]{../plots/fit-assumptions}    
    \caption{Plots for confirming model assumptions.}    
    \label{fit-assumptions}
\end{figure}
\clearpage



\clearpage

\begin{figure}[!ht]
    \center
    \input{../plots/travelcard_error_pct.tex}
    \caption{Error percentage of a single week.}
    \label{fig:travelcard_error_pct}
\end{figure}

\begin{figure}[!ht]
    \center
    \input{../plots/weather_rain.tex}
    \caption{Error percentage of a single week.}
    \label{fig:weather_rain}
\end{figure}


\clearpage

\section{Problem and Data}\label{ch:data_old}
This project aims to shed light upon the impact of specifically weather as an external factor for bus travel demand. The goal is to visualize and understand the data described in the following, and to show if any significant correlations between the datasets exists. Finally an simple model for travel demand prediction should be build in R.

For the sake of simplicity the analysis is expected to be limited to a single geographical area (e.g. Copenhagen) and bus line.

\subsection{Checking model assumptions}
\todo{Check model assumptions}

\clearpage
\begin{spacing}{1}
  \bibliographystyle{apalike}
  \addcontentsline{toc}{section}{References}
  \bibliography{../references/library}
\end{spacing}

\clearpage
\appendix
\section*{Appendices}
\addcontentsline{toc}{section}{Appendices}
\renewcommand{\thesubsection}{\Alph{subsection}}

\input{appx_travel_demand_data.tex}
\clearpage
\input{appx_weather_data.tex}

\end{document}
